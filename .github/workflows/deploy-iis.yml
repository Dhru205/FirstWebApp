name: Build and Deploy .NET Framework MVC to IIS

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build on GitHub-hosted Runner
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Restore NuGet packages
        run: nuget restore FirstWebApp.sln

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Build and Publish to Folder
        shell: powershell
        run: |
          $publishDir = "$env:GITHUB_WORKSPACE\publish"
          msbuild FirstWebApp\FirstWebApp.csproj `
            /t:Build `
            /p:Configuration=Release `
            /p:OutputPath=$publishDir

          Write-Host "`nâœ… Publish folder created at: $publishDir"
          Get-ChildItem -Path $publishDir | Format-Table Mode, LastWriteTime, Length, Name -AutoSize

      - name: Upload Published Output as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: publish/

  deploy:
    name: Deploy to IIS on Self-hosted Server
    needs: build
    runs-on: self-hosted

    steps:
      - name: Download Published Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: ./publish

      - name: Stop IIS
        shell: powershell
        run: iisreset /stop

      - name: Copy Files to IIS Site Folder
        shell: powershell
        run: |
          $source = "$env:GITHUB_WORKSPACE\publish"
          $destination = "C:\Users\HP\Documents\dotnet-publish"  # ðŸ‘ˆ Update to your IIS folder if needed
          
          if (-Not (Test-Path $source)) {
            throw "Publish folder not found: $source"
          }

          Write-Host "`n Copying from $source to $destination..."
          Remove-Item "$destination\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "$source\*" -Destination $destination -Recurse -Force

      - name: Start IIS
        shell: powershell
        run: iisreset /start
